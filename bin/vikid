#!/usr/bin/env python3

"""
Viki daemon
~~~~~~~~~~~

The automation framework

Usage:
    jobs
    job/<jobName>
    job/<jobName>/run

Maintainer:
    John Shanahan <shanahan.jrs@gmail.com>

License:
    Apache 2.0
    http://www.apache.org/licenses/LICENSE-2.0

"""


# --- Imports

try:
    import signal
    import sys

    from flask import Flask, request, jsonify
    import os
    import logging
    from logging.config import dictConfig

    from src.job.job import Job
    from src.application import app as viki_app
    from src.blueprints import api_blueprint, ui_blueprint

except ImportError as error:
    sys.exit('ImportError: ' + str(error))


# --- Setup

debug = True


# --- Classes / globals

app = Flask(__name__)
job = Job()
version = viki_app.version

if not viki_app.check_system_setup():
    sys.exit('System check failed. Please run `sudo viki --setup`')

# TODO pull all of this from App
home_directory = viki_app.home
dictConfig(viki_app.logging_config)
logger = logging.getLogger()

# Start logging
logger.info('===== Vikid =====')

# --- UI Route

app.register_blueprint(ui_blueprint.ui_blueprint)


# --- Api Route

app.register_blueprint(api_blueprint.api_blueprint)


# --- Start

# Grab a keyboard interrupt
def signal_handler(signal, frame):
    print('Keyboard interrupt')
    sys.exit(130)

signal.signal(signal.SIGINT, signal_handler)

app.run(port=9898)
